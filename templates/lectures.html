{% extends "base.html" %}
{% block styles %}
<style>
    #bg-grid {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: grid;
      grid-template-columns: repeat(auto-fill, 30px);
      grid-auto-rows: 30px;
      z-index: -9999; /* push fully behind */
      pointer-events: none;
      transform: none;
    }

  .grid-cell {
    width: 30px;
    height: 30px;
    background: #0a1a3a;
    transition: background 0.12s linear;
  }

  .grid-cell.active {
    background: #1e90ff;
  }

  @keyframes cellPulse {
    0% { background: #1e90ff; }
    100% { background: #0a1a3a; }
  }

  .grid-cell.pulse {
    animation: cellPulse 0.4s forwards;
  }
</style>
{% endblock styles %}

{% block content %}
<div id="bg-grid"></div>

<main class="lectures-page">
  <section class="lectures-header">
    <button id="btn-create-post" aria-haspopup="dialog">Create a Post</button>
  </section>

  <section id="posts-list">
    {% for post in posts %}

    <!-- ========================= -->
    <!-- QUEUE DEMO (ONLY ONCE)  -->
    <!-- ========================= -->
    {% if loop.first %}
    <article class="post-card">
      <header>
        <h3 class="post-title">Queue Interactive Demo</h3>
        <p class="post-caption">Visualize enqueue and dequeue operations in real time.</p>
      </header>

      <div style="margin:10px 0;">
        <input id="queue-input" type="text" placeholder="Value‚Ä¶" />
        <button id="queue-enqueue">Enqueue</button>
        <button id="queue-dequeue">Dequeue</button>
      </div>

      <div id="queue-display" style="padding:10px;border:1px solid #ccc;"></div>
    </article>

    <!-- STACK DEMO -->
    <article class="post-card">
      <header>
        <h3 class="post-title">Stack Interactive Demo</h3>
        <p class="post-caption">Push and pop to see how LIFO works.</p>
      </header>

      <div style="margin:10px 0;">
        <input id="stack-input" type="text" placeholder="Value‚Ä¶" />
        <button id="stack-push">Push</button>
        <button id="stack-pop">Pop</button>
      </div>

      <div id="stack-display" style="padding:10px;border:1px solid #ccc;"></div>
    </article>
<!-- TREE DEMO -->
<article class="post-card">
  <header>
    <h3 class="post-title">Tree (General) Interactive Demo</h3>
    <p class="post-caption">Add children to selected nodes.</p>
  </header>

  <div style="margin:10px 0;">
    <input id="tree-input" type="text" placeholder="Node value‚Ä¶" />
    <button id="tree-add-root">Add Root</button>
    <button id="tree-add-child">Add Child</button>
  </div>

  <div id="tree-display" style="padding:10px;border:1px solid #ccc;"></div>
</article>


<!-- BINARY TREE DEMO -->
<article class="post-card">
  <header>
    <h3 class="post-title">Binary Tree Demo</h3>
    <p class="post-caption">Insert nodes left or right.</p>
  </header>

  <div style="margin:10px 0;">
    <input id="bt-input" type="text" placeholder="Value‚Ä¶" />
    <button id="bt-add-left">Add Left</button>
    <button id="bt-add-right">Add Right</button>
    <button id="bt-reset">Reset</button>
  </div>

  <div id="bt-display" style="padding:10px;border:1px solid #ccc;"></div>
</article>


<!-- BST DEMO -->
<article class="post-card">
  <header>
    <h3 class="post-title">BST Demo</h3>
    <p class="post-caption">Insert values into a Binary Search Tree.</p>
  </header>

  <div style="margin:10px 0;">
    <input id="bst-input" type="text" placeholder="Insert value‚Ä¶" />
    <button id="bst-insert">Insert</button>
    <button id="bst-reset">Reset</button>
  </div>

  <div id="bst-display" style="padding:10px;border:1px solid #ccc;"></div>
</article>

    {% endif %}

    <!-- ========================= -->
    <!-- REGULAR POSTS            -->
    <!-- ========================= -->
    {% if post.id > 0 %}
    <article class="post-card" data-id="{{ post.id }}">
      <div class="three-dots" data-id="{{ post.id }}">‚ãØ</div>
      <div class="dropdown-menu" id="menu-{{ post.id }}">
        <button class="edit-post" data-id="{{ post.id }}" data-title="{{ post.title }}" data-caption="{{ post.caption }}" data-author="{{ post.author }}">‚úèÔ∏è Edit</button>
        <button class="delete-post" onclick="deletePost({{ post.id }})">üóëÔ∏è Delete</button>
      </div>

      <header>
        <h3 class="post-title">{{ post.title }}</h3>
        <p class="post-caption">{{ post.caption }}</p> <p class="post-caption preserve">{{ post.caption }}</p>
      </header>
      <footer>
        <button class="vote-up" data-id="{{ post.id }}">‚ñ≤ <span class="count">{{ post.up }}</span></button>
        <button class="vote-down" data-id="{{ post.id }}">‚ñº <span class="count">{{ post.down }}</span></button>
      </footer>
    </article>
    {% endif %}

    {% endfor %}
  </section>
</main>

<!-- ===================================== -->
<!-- POST MODAL (CREATE + EDIT)            -->
<!-- ===================================== -->
<div id="create-post-modal" class="modal" role="dialog" aria-hidden="true">
  <div class="modal-content">
    <h2 id="modal-title">Create a Post</h2>

    <form id="post-form" method="POST" action="{{ url_for('create_post') }}">
      <input type="hidden" id="post-id" name="id" value="">

      <label>Title:</label>
      <input type="text" id="post-title-input" name="title" required>

      <label>Caption:</label>
      <textarea id="post-caption-input" name="caption" required></textarea>

      <label>Author:</label>
      <input type="text" id="post-author-input" name="author" required>

      <label>Post Type:</label>
      <select name="post_type">
        <option value="regular">Regular</option>
      </select>

      <div style="margin-top:10px;">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-ghost" id="post-cancel">Cancel</button>
      </div>
    </form>
  </div>
</div>
<div id="snackbar" class="snackbar" style="display:none;">
  Deleting in 5 seconds...
  <button onclick="cancelDelete()">Cancel</button>
</div>

<!-- ===================================== -->
<!-- JAVASCRIPT FIXED                      -->
<!-- ===================================== -->
<script>
/* ----------------------------- */
/* Element refs                 */
/* ----------------------------- */
const createPostBtn = document.getElementById('btn-create-post');
const createPostModal = document.getElementById('create-post-modal');
const cancelPostBtn = document.getElementById('post-cancel');
const modalTitle = document.getElementById('modal-title');
const postForm = document.getElementById('post-form');
const postIdInput = document.getElementById('post-id');
const postTitleInput = document.getElementById('post-title-input');
const postCaptionInput = document.getElementById('post-caption-input');
const postAuthorInput = document.getElementById('post-author-input');

/* Queue + Stack refs */
const queueInput = document.getElementById("queue-input");
const queueEnqueue = document.getElementById("queue-enqueue");
const queueDequeue = document.getElementById("queue-dequeue");
const queueDisplay = document.getElementById("queue-display");

const stackInput = document.getElementById("stack-input");
const stackPush = document.getElementById("stack-push");
const stackPop = document.getElementById("stack-pop");
const stackDisplay = document.getElementById("stack-display");

/* Tree refs */
const treeInput = document.getElementById("tree-input");
const treeAddRoot = document.getElementById("tree-add-root");
const treeAddChild = document.getElementById("tree-add-child");
const treeDisplay = document.getElementById("tree-display");

/* Binary Tree refs */
const btInput = document.getElementById("bt-input");
const btAddLeft = document.getElementById("bt-add-left");
const btAddRight = document.getElementById("bt-add-right");
const btReset = document.getElementById("bt-reset");
const btDisplay = document.getElementById("bt-display");

/* BST refs */
const bstInput = document.getElementById("bst-input");
const bstInsert = document.getElementById("bst-insert");
const bstReset = document.getElementById("bst-reset");
const bstDisplay = document.getElementById("bst-display");

/* ----------------------------- */
/* Modal Actions                 */
/* ----------------------------- */
createPostBtn.addEventListener('click', () => {
  modalTitle.innerText = "Create a Post";
  postForm.action = "{{ url_for('create_post') }}";
  postIdInput.value = "";
  postTitleInput.value = "";
  postCaptionInput.value = "";
  postAuthorInput.value = "";
  createPostModal.style.display = "flex";
});

cancelPostBtn.addEventListener('click', () => {
  createPostModal.style.display = "none";
});

window.addEventListener('click', (e) => {
  if (e.target === createPostModal) createPostModal.style.display = "none";
});

/* ----------------------------- */
/* Dropdown menu                */
/* ----------------------------- */
document.addEventListener('click', (e) => {
  const dots = e.target.closest('.three-dots');
  const insideMenu = e.target.closest('.dropdown-menu');

  if (dots) {
    const id = dots.dataset.id;
    const menu = document.getElementById(`menu-${id}`);
    document.querySelectorAll('.dropdown-menu').forEach(m => {
      if (m !== menu) m.style.display = 'none';
    });
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    return;
  }

  if (!insideMenu) {
    document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
  }
});

/* ----------------------------- */
/* Edit post                    */
/* ----------------------------- */
document.querySelectorAll('.edit-post').forEach(btn => {
  btn.addEventListener('click', () => {
    modalTitle.innerText = "Edit Post";
    postForm.action = `/edit/${btn.dataset.id}`;
    postIdInput.value = btn.dataset.id;
    postTitleInput.value = btn.dataset.title;
    postCaptionInput.value = btn.dataset.caption;
    postAuthorInput.value = btn.dataset.author;
    createPostModal.style.display = "flex";
  });
});

/* ----------------------------- */
/* Backend API wrapper          */
/* ----------------------------- */
async function api(url, data = {}) {
  let res = await fetch(url, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(data)
  });
  return res.json();
}

/* ----------------------------- */
/* QUEUE DEMO FIXED             */
/* ----------------------------- */
queueEnqueue.onclick = async () => {
  let out = await api("/queue/enqueue", { value: queueInput.value });
  queueDisplay.innerHTML = out.queue.join(" ‚Üí ");
};

queueDequeue.onclick = async () => {
  let out = await api("/queue/dequeue");
  queueDisplay.innerHTML = out.queue.join(" ‚Üí ");
};

/* ----------------------------- */
/* STACK DEMO FIXED             */
/* ----------------------------- */
stackPush.onclick = async () => {
  let out = await api("/stack/push", { value: stackInput.value });
  stackDisplay.innerHTML = out.stack.slice().reverse().join("<br>");
};

stackPop.onclick = async () => {
  let out = await api("/stack/pop");
  stackDisplay.innerHTML = out.stack.slice().reverse().join("<br>");
};
    /* TREE */
treeAddRoot.onclick = async () => {
  let out = await api("/tree/add_root", { value: treeInput.value });
  treeDisplay.innerHTML = out.render;
};
treeAddChild.onclick = async () => {
  let out = await api("/tree/add_child", { value: treeInput.value });
  treeDisplay.innerHTML = out.render;
};


/* BINARY TREE */
btAddLeft.onclick = async () => {
  let out = await api("/bt/add_left", { value: btInput.value });
  btDisplay.innerHTML = out.render;
};
btAddRight.onclick = async () => {
  let out = await api("/bt/add_right", { value: btInput.value });
  btDisplay.innerHTML = out.render;
};
btReset.onclick = async () => {
  let out = await api("/bt/reset");
  btDisplay.innerHTML = out.render;
};


/* BST */
bstInsert.onclick = async () => {
  let out = await api("/bst/insert", { value: bstInput.value });
  bstDisplay.innerHTML = out.render;
};
bstReset.onclick = async () => {
  let out = await api("/bst/reset");
  bstDisplay.innerHTML = out.render;
};
let deleteQueue = null;

function deletePost(id) {
  // 1. Show snackbar
  document.getElementById("snackbar").style.display = "flex";

  // 2. Push delete into the queue (5s delay)
  deleteQueue = setTimeout(() => {
      fetch(`/delete/${id}`, { method: "POST" })
        .then(() => location.reload());
  }, 5000);
}

function cancelDelete() {
  clearTimeout(deleteQueue);
  document.getElementById("snackbar").style.display = "none";
}

    // GRID BACKGROUND EFFECT
document.addEventListener("DOMContentLoaded", () => {
  const grid = document.getElementById("bg-grid");
  const cellSize = 30;

  function createGrid() {
    grid.innerHTML = "";
    const cols = Math.ceil(window.innerWidth / cellSize) + 2;
    const rows = Math.ceil(window.innerHeight / cellSize) + 2;

    grid.style.gridTemplateColumns = `repeat(${cols}, ${cellSize}px)`;
    grid.style.width = `${cols * cellSize}px`;
    grid.style.height = `${rows * cellSize}px`;

    const total = cols * rows;
    for (let i = 0; i < total; i++) {
      const cell = document.createElement("div");
      cell.classList.add("grid-cell");
      grid.appendChild(cell);
    }

    return { cols, rows, cells: Array.from(grid.children) };
  }

  let { cols, rows, cells } = createGrid();

  function pulseCell(col, row) {
    if (col < 0 || row < 0 || col >= cols || row >= rows) return;
    const idx = row * cols + col;
    const cell = cells[idx];
    if (!cell) return;
    cell.classList.add("active", "pulse");
    setTimeout(() => cell.classList.remove("active"), 120);
    setTimeout(() => cell.classList.remove("pulse"), 400);
  }

  window.addEventListener("mousemove", e => {
    const rect = grid.getBoundingClientRect();
    const col = Math.floor((e.clientX - rect.left) / cellSize);
    const row = Math.floor((e.clientY - rect.top) / cellSize);

    for (let dx = -1; dx <= 1; dx++)
      for (let dy = -1; dy <= 1; dy++)
        pulseCell(col + dx, row + dy);
  });

  window.addEventListener("resize", () => {
    ({ cols, rows, cells } = createGrid());
  });
});

</script>

{% endblock %}